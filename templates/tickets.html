<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tickets</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-dark text-white">
  <div class="container mt-5">
    <h2>Ticket Management</h2>

    <!-- Create Ticket button -->
    <div class="d-flex justify-content-end mb-3">
      <a href="{{ url_for('create_ticket') }}" class="btn btn-success">Create Ticket</a>
    </div>

    <!-- Filter section: Always show status filter; user filter only for admin -->
    <form method="GET" action="{{ url_for('list_tickets') }}" class="mb-4 row g-3 align-items-end">

      {% if current_user.role == 'admin' %}
      <!-- User Filter for Admin -->
      <div class="col-auto">
        <label for="userFilter" class="form-label text-white">Filter by User:</label>
        <select name="user" id="userFilter" class="form-select">
          <option value="">All Users</option>
          {% for user in users %}
            <option value="{{ user.id }}" {% if selected_user_id and user.id == selected_user_id|int %}selected{% endif %}>
              {{ user.username }}
            </option>
          {% endfor %}
        </select>
      </div>
      {% endif %}

      <!-- Status Filter for Everyone -->
      <div class="col-auto">
        <label for="statusFilter" class="form-label text-white">Status:</label>
        <select name="status" id="statusFilter" class="form-select">
          <option value="open" {% if selected_status == 'open' %}selected{% endif %}>Open</option>
          <option value="closed" {% if selected_status == 'closed' %}selected{% endif %}>Closed</option>
          <option value="all" {% if selected_status == 'all' %}selected{% endif %}>All</option>
        </select>
      </div>

      <div class="col-auto">
        <button type="submit" class="btn btn-primary mt-3">Apply Filters</button>
      </div>
    </form>

    <table class="table table-dark table-striped">
      <thead>
        <tr>
          <th>Ticket No</th>
          <th>Title</th>
          <th>Issue</th>
          <th>Assigned To</th>
          <th>Status</th>
          <th>Created At</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody>
        {% for ticket in tickets %}
        <tr>
          <td>{{ ticket.ticket_no }}</td>
          <td>{{ ticket.title }}</td>
          <td>{{ ticket.description }}</td>
          <td>
            {% if ticket.assigned_user %}
              {{ ticket.assigned_user.full_name or ticket.assigned_user.username }}
            {% else %}
              Not Assigned
            {% endif %}
          </td>
          <td>{{ ticket.status }}</td>
          <td>{{ ticket.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
          <td>
              <a href="{{ url_for('ticket_detail', ticket_id=ticket.id) }}" class="btn btn-sm btn-primary">View</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</body>
</html>
